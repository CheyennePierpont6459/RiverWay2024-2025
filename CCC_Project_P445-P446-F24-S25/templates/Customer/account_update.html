{% extends "Customer/customer_base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Update Your Account</h2>
  <p>You may update your email, password, or phone number below. (Note: Your OTP must be verified before you can update your account.)</p>
  <form id="accountUpdateForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="mb-3">
      <label for="newEmail" class="form-label">New Email:</label>
      <input type="email" id="newEmail" class="form-control" placeholder="Enter new email">
    </div>
    <div class="mb-3">
      <label for="newPassword" class="form-label">New Password:</label>
      <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
    </div>
    <div class="mb-3">
      <label for="newPhone" class="form-label">New Phone Number:</label>
      <input type="text" id="newPhone" class="form-control" placeholder="Enter new phone number">
    </div>
    <button type="submit" class="btn btn-success">Update Account</button>
  </form>
  <div id="accountUpdateFlash" class="mt-3"></div>
</div>

<script>
  document.getElementById('accountUpdateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newEmail = document.getElementById('newEmail').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const newPhone = document.getElementById('newPhone').value.trim();
    try {
      const response = await fetch('/account_update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': "{{ csrf_token() }}"
        },
        body: JSON.stringify({ new_email: newEmail, new_password: newPassword, new_phone: newPhone })
      });
      const result = await response.json();
      const flashDiv = document.getElementById('accountUpdateFlash');
      if (result.success) {
        flashDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
        setTimeout(() => {
          window.location.href = "/customer_dashboard?st={{ session_token }}";
        }, 1500);
      } else {
        flashDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
      }
    } catch (error) {
      document.getElementById('accountUpdateFlash').innerHTML =
        `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
  });
</script>
{% endblock %}