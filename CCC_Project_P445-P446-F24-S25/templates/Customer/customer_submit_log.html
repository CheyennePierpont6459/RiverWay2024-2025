<!-- templates/Customer/submit_log.html -->
{% extends "Customer/customer_base.html" %}

{% block content %}
<h1>Submit Emergency Log</h1>
<form id="emergencyForm">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div>
    <label>Location Details:</label><br>
    <textarea id="locationField" required></textarea>
  </div>
  <div>
    <label>Distress Notes:</label><br>
    <textarea id="distressField" required></textarea>
  </div>
  <button type="submit">Submit Emergency</button>
</form>

<p><a href="{{ url_for('reviews_page', st=session_token) }}">Go to Reviews</a></p>
<hr>
<div id="emergencyResult"></div>

<h2>My Emergency Logs</h2>
<div id="emergencyList"></div>

<script>
  document.getElementById('emergencyForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const locationDetails = document.getElementById('locationField').value.trim();
    const distressNotes = document.getElementById('distressField').value.trim();

    try {
      const response = await fetch('/api/emergency', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({ location_details: locationDetails, distress_notes: distressNotes })
      });
      const result = await response.json();
      const resultDiv = document.getElementById('emergencyResult');
      if (result.success) {
        resultDiv.innerHTML = `<p class="text-success">${result.message}</p>`;
        loadEmergencies();
      } else {
        resultDiv.innerHTML = `<p class="text-danger">${result.message}</p>`;
      }
    } catch (error) {
      document.getElementById('emergencyResult').innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  async function loadEmergencies() {
    try {
      const response = await fetch(`/api/emergency?st={{ session_token }}`, {
  method: 'GET',
  headers: { 'Content-Type': 'application/json' }
});
      const data = await response.json();
      if (data.success) {
        const emergencyList = document.getElementById('emergencyList');
        emergencyList.innerHTML = data.emergencies
          .map(em =>
            `<div class="emergency">
              <p><strong>ID:</strong> ${em.emergency_id}</p>
              <p><strong>Location:</strong> ${em.location_details}</p>
              <p><strong>Notes:</strong> ${em.distress_notes}</p>
              <p><strong>Date:</strong> ${em.created_at}</p>
            </div>`
          )
          .join('');
      }
    } catch (error) {
      console.error("Error loading emergencies:", error);
    }
  }

  loadEmergencies();
</script>
{% endblock %}