{% extends "employee_base.html" %}

{% block title %}My Claimed Emergencies{% endblock %}

{% block content %}
<h1>My Claimed Emergencies</h1>
{% if emergencies %}
<ul id="emergency-list">
    {% for emergency in emergencies %}
    <li id="emergency-{{ emergency.emergency_id }}">
        <strong>Emergency ID:</strong> {{ emergency.emergency_id }}<br>
        <strong>Location:</strong> {{ emergency.location_details }}<br>
        <strong>Notes:</strong> {{ emergency.distress_notes }}<br>
        <strong>Customer:</strong> {{ emergency.customer }}<br>
        <button class="resolve-button" data-id="{{ emergency.emergency_id }}">Resolve</button>
    </li>
    {% endfor %}
</ul>
{% else %}
<p>You have no claimed emergencies at the moment.</p>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const resolveButtons = document.querySelectorAll('.resolve-button');

        resolveButtons.forEach(button => {
            button.addEventListener('click', async (event) => {
                const emergencyId = event.target.getAttribute('data-id');
                const confirmResolve = confirm(`Are you sure you want to resolve Emergency ID ${emergencyId}?`);

                if (!confirmResolve) {
                    return;
                }

                try {
                    const response = await fetch('/employee/resolve_emergency', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': CSRF_TOKEN  // Ensure CSRF token is included
                        },
                        body: JSON.stringify({ emergency_id: emergencyId })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        alert(result.message);
                        // Remove the resolved emergency from the list without reloading
                        const emergencyItem = document.getElementById(`emergency-${emergencyId}`);
                        if (emergencyItem) {
                            emergencyItem.remove();
                        }
                    } else {
                        alert(result.message || 'Failed to resolve emergency.');
                    }
                } catch (error) {
                    console.error('Error resolving emergency:', error);
                    alert('An error occurred. Please try again.');
                }
            });
        });
    });
</script>
{% endblock %}