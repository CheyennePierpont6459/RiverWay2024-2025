{% extends "Employee/employee_base.html" %}

{% block title %}All Emergencies{% endblock %}

{% block content %}
<h1>All Emergencies</h1>
{% if emergencies %}
<ul>
    {% for emergency in emergencies %}
    <li>
        <strong>Emergency ID:</strong> {{ emergency.emergency_id }}<br>
        <strong>Location:</strong> {{ emergency.location_details }}<br>
        <strong>Notes:</strong> {{ emergency.distress_notes }}<br>
        <strong>Status:</strong>
        {% if emergency.is_claimed %}
            Claimed by {{ emergency.claimed_by }}
        {% else %}
            Unclaimed
            <button onclick="claimEmergency({{ emergency.emergency_id }})">Claim</button>
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% else %}
<p>No emergencies found.</p>
{% endif %}

<script>
    // Retrieve CSRF token from meta tag
    const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    async function claimEmergency(emergencyId) {
        try {
            const response = await fetch('/employee/claim_emergency', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN  // Include the CSRF token here
                },
                body: JSON.stringify({ emergency_id: emergencyId })
            });
            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                location.reload();
            } else {
                alert(result.message || 'Failed to claim emergency.');
            }
        } catch (error) {
            console.error('Error claiming emergency:', error);
            alert('An error occurred. Please try again.');
        }
    }
</script>
{% endblock %}