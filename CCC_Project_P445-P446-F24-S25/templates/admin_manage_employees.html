{% extends "admin_base.html" %}

{% block content %}
    <h2>Manage Employees</h2>
    <button class="btn btn-submit" onclick="showCreateEmployeeForm()">Create New Employee</button>

    <!-- Employee Table -->
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Phone Number</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for employee in employees %}
            <tr>
                <td>{{ employee.user_id }}</td>
                <td>{{ employee.username }}</td>
                <td>{{ employee.email }}</td>
                <td>{{ employee.phone_number }}</td>
                <td>
                    <button class="btn btn-update" onclick="updateEmployee({{ employee.user_id }})">Update</button>
                    <button class="btn btn-delete" onclick="deleteEmployee({{ employee.user_id }})">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Create Employee Form (Hidden by Default) -->
    <div id="createEmployeeForm" style="display:none; margin-top: 20px;">
        <h3>Create New Employee</h3>
        <div class="form-group">
            <label for="new_username">Username:</label>
            <input type="text" id="new_username" name="new_username" required>
        </div>
        <div class="form-group">
            <label for="new_email">Email:</label>
            <input type="email" id="new_email" name="new_email" required>
        </div>
        <div class="form-group">
            <label for="new_password">Password:</label>
            <input type="password" id="new_password" name="new_password" required>
        </div>
        <div class="form-group">
            <label for="new_phone_number">Phone Number:</label>
            <input type="text" id="new_phone_number" name="new_phone_number" required>
        </div>
        <button class="btn-submit" onclick="createEmployee()">Submit</button>
        <button class="btn btn-delete" onclick="hideCreateEmployeeForm()">Cancel</button>
    </div>

    <!-- Update Employee Form (Hidden by Default) -->
    <div id="updateEmployeeForm" style="display:none; margin-top: 20px;">
        <h3>Update Employee</h3>
        <div class="form-group">
            <label for="update_username">Username:</label>
            <input type="text" id="update_username" name="update_username" required>
        </div>
        <div class="form-group">
            <label for="update_email">Email:</label>
            <input type="email" id="update_email" name="update_email" required>
        </div>
        <div class="form-group">
            <label for="update_password">Password:</label>
            <input type="password" id="update_password" name="update_password" placeholder="Leave blank to keep current password">
        </div>
        <div class="form-group">
            <label for="update_phone_number">Phone Number:</label>
            <input type="text" id="update_phone_number" name="update_phone_number" required>
        </div>
        <button class="btn-submit" onclick="submitUpdateEmployee()">Update</button>
        <button class="btn btn-delete" onclick="hideUpdateEmployeeForm()">Cancel</button>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Show Create Employee Form
    function showCreateEmployeeForm() {
        document.getElementById('createEmployeeForm').style.display = 'block';
    }

    // Hide Create Employee Form
    function hideCreateEmployeeForm() {
        document.getElementById('createEmployeeForm').style.display = 'none';
    }

    // Create Employee via API
    async function createEmployee() {
        const username = document.getElementById('new_username').value.trim();
        const email = document.getElementById('new_email').value.trim();
        const password = document.getElementById('new_password').value.trim();
        const phone_number = document.getElementById('new_phone_number').value.trim();

        if (!username || !email || !password || !phone_number) {
            alert("All fields are required.");
            return;
        }

        const response = await fetch('/api/admin/create_employee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, email, password, phone_number }),
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    }

    // Delete Employee via API
    async function deleteEmployee(employee_id) {
        if (!confirm("Are you sure you want to delete this employee?")) return;

        const response = await fetch('/api/admin/delete_employee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ employee_id }),
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    }

    // Update Employee - Load Current Data
    function updateEmployee(employee_id) {
        // Fetch employee data (assuming there is an endpoint or include data in the table)
        // For simplicity, extract data from the table row

        const row = event.target.parentElement.parentElement;
        const username = row.cells[1].innerText;
        const email = row.cells[2].innerText;
        const phone_number = row.cells[3].innerText;

        // Populate the update form
        document.getElementById('update_username').value = username;
        document.getElementById('update_email').value = email;
        document.getElementById('update_phone_number').value = phone_number;

        // Store employee_id in a hidden field or a global variable
        window.currentUpdateEmployeeId = employee_id;

        // Show the update form
        document.getElementById('updateEmployeeForm').style.display = 'block';
    }

    // Hide Update Employee Form
    function hideUpdateEmployeeForm() {
        document.getElementById('updateEmployeeForm').style.display = 'none';
        window.currentUpdateEmployeeId = null;
    }

    // Submit Updated Employee Data via API
    async function submitUpdateEmployee() {
        const employee_id = window.currentUpdateEmployeeId;
        if (!employee_id) {
            alert("No employee selected for update.");
            return;
        }

        const username = document.getElementById('update_username').value.trim();
        const email = document.getElementById('update_email').value.trim();
        const password = document.getElementById('update_password').value.trim();
        const phone_number = document.getElementById('update_phone_number').value.trim();

        if (!username || !email || !phone_number) {
            alert("Username, Email, and Phone Number are required.");
            return;
        }

        const payload = { username, email, phone_number };
        if (password) {
            payload.password = password;
        }

        const response = await fetch('/api/admin/update_employee/' + employee_id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });

        const data = await response.json();
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    }
</script>
{% endblock %}